<!doctype html><!doctype html>

<html lang="en"><html lang="en">

<head><head>

    <meta charset="UTF-8">    <meta charset="UTF-8">

    <link rel="icon" type="image/svg+xml" href="../images/svg/AI.svg">    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"

    <title>AI Agent - Chat Ospite</title>          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">    <link rel="stylesheet" href="../css/nav-sytle.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">    <link rel="stylesheet" href="../css/button-wish.css">

    <style>    <link rel="stylesheet" href="../css/clothes-images.css">

        body {    <link rel="stylesheet" href="../css/button-buy.css">

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);    <link rel="stylesheet" href="../css/menu.css">

            min-height: 100vh;    <link rel="stylesheet" href="../css/button-counter-page.css">

            padding: 50px 20px;    <link rel="icon" href="../images/svg/tab-icon.svg" type="image/svg+xml">

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;    <title>Miku's web site</title>

        }</head>

    <body style="background-color: bisque;">

        .chat-container {    <nav class="navbar navbar-expand-lg custom-navbar-bg">

            max-width: 700px;        <div class="container-fluid" id="banner-container" >

            margin: 0 auto;            <img src="../images/svg/shop-icon.svg" id="shop-icon" class="cart-icon" alt="cart">

            background: #ffffff;            <a class="navbar-brand d-flex justify-content-start" href="#" aria-posinset="ml-auto">Miku's Shop</a>

            border-radius: 20px;            <div class="mx-0" id="profile-Pic">

            box-shadow: 0 10px 30px rgba(0,0,0,0.2);                    <label id="label-nome-utente">Guest </label>

            padding: 30px;                <img src="../images/svg/login-icon.svg" onerror="this.style.display='none'" class="profile-icon">

            backdrop-filter: blur(10px);                <div class="dropdown">

            height: 80vh;

            display: flex;                </div>

            flex-direction: column;            </div>

        }

        </div>

        .chat-messages {    </nav>

            flex: 1;    <div id="menu-container" > </div> <!--div del menu-->

            overflow-y: auto;    <main class="container mt-4">

            padding: 20px 0;        <div class="row" id="product-list">

            margin-bottom: 20px;            <!-- I prodotti saranno inseriti qui -->

            border-bottom: 2px solid #f0f0f0;        </div>

        }    </main>

    <div id="pagination-container">

        .message {

            margin-bottom: 15px;    </div>

            display: flex;    <!-- Image Modal -->

            align-items: flex-start;    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">

        }        <div class="modal-dialog modal-dialog-centered">

            <div class="modal-content">

        .message.user {                <div class="modal-header">

            justify-content: flex-end;                    <h5 class="modal-title" id="imageModalLabel">Product Image</h5>

        }                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                </div>

        .message.ai {                <div class="modal-body text-center">

            justify-content: flex-start;                    <img id="modalImage" src="" alt="Product Image" class="img-fluid">

        }                </div>

            </div>

        .message-bubble {        </div>

            max-width: 70%;    </div>

            padding: 12px 16px;

            border-radius: 18px;

            word-wrap: break-word;

        }

<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">

        .message.user .message-bubble {    <div class="modal-dialog">

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);        <div class="modal-content">

            color: white;            <div class="modal-header">

            border-bottom-right-radius: 5px;                <h5 class="modal-title" id="loginModalLabel">Account</h5>

        }                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

            </div>

        .message.ai .message-bubble {            <div class="modal-body" id="modal-body">

            background: #f0f2f5;                <!-- Login form will be injected here -->

            color: #333;            </div>

            border-bottom-left-radius: 5px;            <div class="modal-footer">

        }                <button type="button" class="btn btn-primary me-auto"  id="registerButton" style="background-color: orangered; border-color: orangered;">Register</button>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

        .message-avatar {            </div>

            width: 30px;        </div>

            height: 30px;    </div>

            border-radius: 50%;</div>

            margin: 0 8px;

            display: flex;

            align-items: center;<!-- Immagine in basso a destra con popup su hover -->

            justify-content: center;<div class="mx-0" id="ai">

            font-size: 14px;    <img src="../images/svg/AI.svg" 

        }         onerror="this.style.display='none'" 

         class="ai-icon" 

        .message.user .message-avatar {         alt="AI Assistant"

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);         id="ai-icon-clickable"> <!-- ← ID aggiunto -->

            color: white;    <div class="ai-popup">Serve aiuto?</div>

            order: 2;</div>

        }



        .message.ai .message-avatar {

            background: #4caf50;

            color: white;

        }<!-- Include Bootstrap JS and dependencies -->

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>

        .chat-input-area {<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

            border-top: 2px solid #f0f0f0;<script type="module" src="../js/script/templates/counterPage.js"></script>

            padding-top: 20px;<script type="module" src="../main.js"> </script>

        }    </body>

</html>
        .guest-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .main-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .btn {
            border-radius: 10px;
            font-weight: 500;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="text-center mb-3">
        <h1 class="main-title">💬 AI Assistant (Modalità Ospite)</h1>
    </div>

    <div class="guest-warning">
        <i class="bi bi-info-circle"></i>
        <strong>Stai usando la modalità ospite.</strong>
        I messaggi non verranno salvati e non avrai personalizzazioni.
        <a href="register.html" class="text-decoration-none">Registrati</a> o 
        <a href="login.html" class="text-decoration-none">accedi</a> per un'esperienza completa.
    </div>

    <!-- Area messaggi chat -->
    <div class="chat-messages" id="chatMessages">
        <div class="message ai">
            <div class="message-avatar">🤖</div>
            <div class="message-bubble">
                Ciao! Sono il tuo assistente AI in modalità ospite. Come posso aiutarti oggi?
            </div>
        </div>
    </div>

    <!-- Area input e pulsanti -->
    <div class="chat-input-area">
        <div class="row g-2 mb-3">
            <div class="col">
                <textarea class="form-control" 
                        id="userInput" 
                        placeholder="Scrivi il tuo messaggio qui..." 
                        rows="2"
                        maxlength="1000"></textarea>
            </div>
            <div class="col-auto d-flex flex-column">
                <button class="btn btn-primary mb-2" id="sendBtn" onclick="sendMessage()">
                    <i class="bi bi-send"></i> Invia
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="resetBtn" onclick="resetChat()">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
            </div>
        </div>
        
        <!-- Loading indicator -->
        <div class="text-center d-none" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">L'AI sta pensando...</p>
        </div>

        <!-- Link autenticazione -->
        <div class="text-center mt-3">
            <small class="text-muted">
                Vuoi un'esperienza personalizzata? 
                <a href="register.html" class="text-decoration-none">Registrati</a> o 
                <a href="login.html" class="text-decoration-none">accedi</a>
            </small>
        </div>
    </div>
</div>

<!-- Script di gestione chat (stesso di AI-page ma senza salvataggio) -->
<script>
let chatHistory = [];

// Inizializza il controller
window.addEventListener('DOMContentLoaded', function() {
    console.log('Guest Chat Controller caricato');
    
    const userInput = document.getElementById('userInput');
    if (userInput) {
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
});

// Funzione per inviare un messaggio
window.sendMessage = async function() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();
    
    if (!message) {
        alert('Per favore inserisci un messaggio');
        return;
    }
    
    try {
        addMessageToChat('user', message);
        chatHistory.push({ role: 'user', content: message });
        
        userInput.value = '';
        showLoading(true);
        
        // Invia alla stessa route ma in modalità ospite
        const response = await fetch('/ai/llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: chatHistory,
                isGuest: true
            })
        });
        
        const data = await response.json();
        
        if (data && data.response) {
            addMessageToChat('ai', data.response);
            chatHistory.push({ role: 'assistant', content: data.response });
        } else {
            addMessageToChat('ai', 'Mi dispiace, si è verificato un errore nel processare la tua richiesta.');
        }
        
    } catch (error) {
        console.error('Errore nell\'invio del messaggio:', error);
        addMessageToChat('ai', 'Mi dispiace, si è verificato un errore di connessione.');
    } finally {
        showLoading(false);
        userInput.focus();
    }
};

// Funzione per aggiungere un messaggio alla chat
function addMessageToChat(sender, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = sender === 'user' ? '👤' : '🤖';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-bubble">${escapeHtml(message)}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Funzione per mostrare/nascondere il loading
function showLoading(show) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const sendBtn = document.getElementById('sendBtn');
    
    if (show) {
        loadingIndicator.classList.remove('d-none');
        sendBtn.disabled = true;
    } else {
        loadingIndicator.classList.add('d-none');
        sendBtn.disabled = false;
    }
}

// Funzione per resettare la chat
window.resetChat = function() {
    if (confirm('Sei sicuro di voler resettare la chat?')) {
        chatHistory = [];
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="message ai">
                <div class="message-avatar">🤖</div>
                <div class="message-bubble">
                    Ciao! Sono il tuo assistente AI in modalità ospite. Come posso aiutarti oggi?
                </div>
            </div>
        `;
        
        document.getElementById('userInput').value = '';
        document.getElementById('userInput').focus();
    }
};

// Funzione di utilità per escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</body>
</html>