<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/routes/users-route.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CartDAO.html">CartDAO</a><ul class='methods'><li data-type='method'><a href="CartDAO.html#.addProductToCart">addProductToCart</a></li><li data-type='method'><a href="CartDAO.html#.decreaseQuantity">decreaseQuantity</a></li><li data-type='method'><a href="CartDAO.html#.getUserCart">getUserCart</a></li><li data-type='method'><a href="CartDAO.html#.getUserCartQuantity">getUserCartQuantity</a></li><li data-type='method'><a href="CartDAO.html#.increaseQuantity">increaseQuantity</a></li><li data-type='method'><a href="CartDAO.html#.removeProductFromCart">removeProductFromCart</a></li></ul></li><li><a href="OrdineDao.html">OrdineDao</a><ul class='methods'><li data-type='method'><a href="OrdineDao.html#.aggiungiOrdine">aggiungiOrdine</a></li><li data-type='method'><a href="OrdineDao.html#.calcolaPagamentoTotaleOrdine">calcolaPagamentoTotaleOrdine</a></li><li data-type='method'><a href="OrdineDao.html#.getUserOrdine">getUserOrdine</a></li></ul></li><li><a href="SpedizoineDAO.html">SpedizoineDAO</a><ul class='methods'><li data-type='method'><a href="SpedizoineDAO.html#.aggiungiSpedizione">aggiungiSpedizione</a></li></ul></li><li><a href="WishlistDAO.html">WishlistDAO</a><ul class='methods'><li data-type='method'><a href="WishlistDAO.html#.addProductToWishlist">addProductToWishlist</a></li><li data-type='method'><a href="WishlistDAO.html#.getUserWishlist">getUserWishlist</a></li><li data-type='method'><a href="WishlistDAO.html#.removeProductFromWishlist">removeProductFromWishlist</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#LocalStrategy">LocalStrategy</a></li><li><a href="global.html#WishListFirtsLog">WishListFirtsLog</a></li><li><a href="global.html#addNewImgManager">addNewImgManager</a></li><li><a href="global.html#addOrdine">addOrdine</a></li><li><a href="global.html#addProductToCart">addProductToCart</a></li><li><a href="global.html#addProfilePic">addProfilePic</a></li><li><a href="global.html#addSpedizione">addSpedizione</a></li><li><a href="global.html#apiRoutes">apiRoutes</a></li><li><a href="global.html#buttonWish">buttonWish</a></li><li><a href="global.html#clickBuyButton">clickBuyButton</a></li><li><a href="global.html#createSuccessHeader">createSuccessHeader</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#effetuaOrdine">effetuaOrdine</a></li><li><a href="global.html#effetuaSpedizione">effetuaSpedizione</a></li><li><a href="global.html#emptyCart">emptyCart</a></li><li><a href="global.html#eventListenersQtyButtons">eventListenersQtyButtons</a></li><li><a href="global.html#fetchProducts">fetchProducts</a></li><li><a href="global.html#filterProducts">filterProducts</a></li><li><a href="global.html#flag">flag</a></li><li><a href="global.html#generateUUID">generateUUID</a></li><li><a href="global.html#getProductsId">getProductsId</a></li><li><a href="global.html#getUserCart">getUserCart</a></li><li><a href="global.html#getUserOrdine">getUserOrdine</a></li><li><a href="global.html#getUsrPfp">getUsrPfp</a></li><li><a href="global.html#getWishedProducts">getWishedProducts</a></li><li><a href="global.html#injectForms">injectForms</a></li><li><a href="global.html#inserisciPagamentoTot">inserisciPagamentoTot</a></li><li><a href="global.html#inserisciPagamentoTotManager">inserisciPagamentoTotManager</a></li><li><a href="global.html#isLoggedIn">isLoggedIn</a></li><li><a href="global.html#loadCart">loadCart</a></li><li><a href="global.html#loadOrdersFromLocalStorage">loadOrdersFromLocalStorage</a></li><li><a href="global.html#loadUserOrdiniPage">loadUserOrdiniPage</a></li><li><a href="global.html#loadUserProfile">loadUserProfile</a></li><li><a href="global.html#loadVirtualCart">loadVirtualCart</a></li><li><a href="global.html#loadWishList">loadWishList</a></li><li><a href="global.html#loadWishlistProducts">loadWishlistProducts</a></li><li><a href="global.html#loginAfterRegistration">loginAfterRegistration</a></li><li><a href="global.html#loginModal">loginModal</a></li><li><a href="global.html#modifyData">modifyData</a></li><li><a href="global.html#passVisibility">passVisibility</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#removeCartProd">removeCartProd</a></li><li><a href="global.html#svuotaCarrello">svuotaCarrello</a></li><li><a href="global.html#updateCart">updateCart</a></li><li><a href="global.html#updateCartQty">updateCartQty</a></li><li><a href="global.html#updatePaginationControls">updatePaginationControls</a></li><li><a href="global.html#updatePfpMain">updatePfpMain</a></li><li><a href="global.html#updateQuantity">updateQuantity</a></li><li><a href="global.html#updateWishlist">updateWishlist</a></li><li><a href="global.html#validateBirthDay">validateBirthDay</a></li><li><a href="global.html#validateEmail">validateEmail</a></li><li><a href="global.html#writeActiveWishButtonsToDatabase">writeActiveWishButtonsToDatabase</a></li><li><a href="global.html#zoomImage">zoomImage</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/routes/users-route.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const express = require('express');
const router = express.Router();
const usersDAO = require('../database/users-dao.js');
const passport = require('passport');
const { hash, compare} = require("bcrypt");
const multer = require('multer');
const upload = multer({ storage: multer.memoryStorage() });

/**
 * Middleware di autenticazione
 * @param req
 * @param res
 * @param next
 * @returns {*}
 */
const isLoggedIn = (req, res, next) => {
    if (req.isAuthenticated()) {
        return next();
    }
    res.status(401).json({ message: "Non autenticato" });
};

/**
 * Login dell'utente
 */
router.post('/users/login', passport.authenticate('local'), (req, res) => {
    res.json({ success: true, user: req.user });
});

/**
 * rotta per ottenere la password
 */
router.post('/users/getUserPassword', (req, res) => {
    const { username, password } = req.body;

    usersDAO.getUserPassword(username, password, (err, isMatch) => {
        if (err) {
            return res.status(500).json({ error: "Internal server error" });
        }
        if (!isMatch) {
            return res.status(401).json({ success: false, message: "Password incorrect" });
        }
        res.json({ success: true, message: "Password verified" });
    });
});

/**
 * rotta per accedera al dao per inserire la pfp
 */
router.post('/uploadProfilePic', upload.single('profilePic'), (req, res) => {
    const user = req.user;
    const file = req.file;

    if (!file) {
        return res.status(400).json({ success: false, error: "Nessun file caricato" });
    }

    // Converte il file in un formato BLOB per il database
    const imgData = file.buffer;

    usersDAO.insertOrUpdatePfp(user.email, imgData, (err) => {
        if (err) {
            return res.status(500).json({ error: "Internal server error" });
        }
        res.status(201).json({ success: true, message: "Profile picture uploaded" });
    });
});

/**
 * rotta per leggere la pfp nel dao
 */
router.get('/getProfilePic', async (req, res) => {
    const user = req.user;
    if (!user) {
        return res.status(400).json({ success: false, error: "Nessun utente al momento" });
    }
    try {
        const profilePicData = await usersDAO.getPfp(user.email);
        if (!profilePicData) {
            return res.status(404).json({ success: false, error: "Nessuna immagine trovata" });
        }
        res.status(200).json({ success: true, profilePic: profilePicData.image });
    } catch (err) {
        console.error("Errore durante il recupero dell'immagine profilo:", err);
        res.status(500).json({ error: "Internal server error" });
    }
});

/**
 * rotta Logout dell'utente
 */
router.get('/users/logout', (req, res, next) => {
    req.logout((err) => {
        if (err) {
            return next(err);
        }
        req.session.destroy(() => {
            res.clearCookie('connect.sid');
            res.redirect('/guest.html');
        });
    });
});

/**
 * Route per la registrazione di un nuovo utente
 */
router.post('/users/registration', (req, res) => {
    const { nome, cognome, email, birthDay, password, username } = req.body;
    const saltRounds = 10;
    hash(password, saltRounds, (err, hashedPassword) => {
        if (err) {
            return res.status(500).json({ error: 'Errore nel generare l\'hash della password' });
        }
        usersDAO.insertNewUser(nome, cognome, email, birthDay, hashedPassword, username, (err, result) => {
            if (err) {
                console.error("Errore durante la registrazione:", err);
                return res.status(500).json({ error: 'Errore durante la registrazione dell\'utente' });
            }

            res.json({ success: true, userId: result.id });
        });
    });
});

/**
 * Route per la modifica dei dati dell'utente
 */
router.post('/users/modifyData', (req, res) => {
    const { nome, cognome, username, email, birthDay } = req.body;
        if (req.err) {
            return res.status(500).json({ error: 'Errore nel generare l\'hash della password' });
        }
        usersDAO.updateUserData(nome, cognome, username, email, birthDay, (err, result) => {
            if (err) {
                console.error("Errore durante l'aggiornamento:", err);
                return res.status(500).json({ error: 'Errore durante l\'aggiornamento dell\'utente' });
            }

            res.json({ success: true, message: 'User data updated successfully' });
        });

});


/**
 * route cambio password di un utente
 */
router.post('/users/change-password', isLoggedIn, async (req, res) => {
    try {
        const { currentPassword, newPassword } = req.body;

        // Verifica la password corrente
        const isMatch = await compare(currentPassword, req.user.password);
        if (!isMatch) {
            return res.status(400).json({ message: 'Password attuale non corretta' });
        }

        // Hash della nuova password
        const hashedPassword = await hash(newPassword, 10);

        // Usa la funzione DAO per aggiornare la password
        await usersDAO.updateUserPassword(req.user.id, hashedPassword);

        res.json({ message: 'Password aggiornata con successo' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Errore nel cambio password' });
    }
});


/**
 * Serializzazione e deserializzazione utente
 */
passport.serializeUser((user, done) => {
    done(null, user.username); // Serializza solo l'username o l'ID utente
});

passport.deserializeUser((username, done) => {
    usersDAO.getUserByUsername(username)
        .then(user => done(null, user))
        .catch(err => done(err, null));
});

/**
 * Configurazione della strategia di autenticazione
 * @type {(function(Object, Function): void)|{}}
 */
const LocalStrategy = require('passport-local').Strategy;

passport.use(new LocalStrategy(async (username, password, done) => {
    try {
        const user = await usersDAO.getUserByUsername(username);
        if (!user) {
            return done(null, false, { message: 'Utente non trovato' });
        }

        // Usa bcrypt per confrontare la password
        const isMatch = await compare(password, user.password);
        if (!isMatch) {
            return done(null, false, { message: 'Password errata' });
        }
        console.log("passport funziona")
        return done(null, user); // Credenziali corrette
    } catch (err) {
        return done(err);
    }
}));

module.exports = router</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Sun Dec 01 2024 15:12:22 GMT+0100 (Ora standard dell’Europa centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
