<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/database/ordine-dao.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CartDAO.html">CartDAO</a><ul class='methods'><li data-type='method'><a href="CartDAO.html#.addProductToCart">addProductToCart</a></li><li data-type='method'><a href="CartDAO.html#.decreaseQuantity">decreaseQuantity</a></li><li data-type='method'><a href="CartDAO.html#.getUserCart">getUserCart</a></li><li data-type='method'><a href="CartDAO.html#.getUserCartQuantity">getUserCartQuantity</a></li><li data-type='method'><a href="CartDAO.html#.increaseQuantity">increaseQuantity</a></li><li data-type='method'><a href="CartDAO.html#.removeProductFromCart">removeProductFromCart</a></li></ul></li><li><a href="OrdineDao.html">OrdineDao</a><ul class='methods'><li data-type='method'><a href="OrdineDao.html#.aggiungiOrdine">aggiungiOrdine</a></li><li data-type='method'><a href="OrdineDao.html#.calcolaPagamentoTotaleOrdine">calcolaPagamentoTotaleOrdine</a></li><li data-type='method'><a href="OrdineDao.html#.getUserOrdine">getUserOrdine</a></li></ul></li><li><a href="SpedizoineDAO.html">SpedizoineDAO</a><ul class='methods'><li data-type='method'><a href="SpedizoineDAO.html#.aggiungiSpedizione">aggiungiSpedizione</a></li></ul></li><li><a href="WishlistDAO.html">WishlistDAO</a><ul class='methods'><li data-type='method'><a href="WishlistDAO.html#.addProductToWishlist">addProductToWishlist</a></li><li data-type='method'><a href="WishlistDAO.html#.getUserWishlist">getUserWishlist</a></li><li data-type='method'><a href="WishlistDAO.html#.removeProductFromWishlist">removeProductFromWishlist</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#LocalStrategy">LocalStrategy</a></li><li><a href="global.html#WishListFirtsLog">WishListFirtsLog</a></li><li><a href="global.html#addNewImgManager">addNewImgManager</a></li><li><a href="global.html#addOrdine">addOrdine</a></li><li><a href="global.html#addProductToCart">addProductToCart</a></li><li><a href="global.html#addProfilePic">addProfilePic</a></li><li><a href="global.html#addSpedizione">addSpedizione</a></li><li><a href="global.html#apiRoutes">apiRoutes</a></li><li><a href="global.html#buttonWish">buttonWish</a></li><li><a href="global.html#clickBuyButton">clickBuyButton</a></li><li><a href="global.html#createSuccessHeader">createSuccessHeader</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#effetuaOrdine">effetuaOrdine</a></li><li><a href="global.html#effetuaSpedizione">effetuaSpedizione</a></li><li><a href="global.html#emptyCart">emptyCart</a></li><li><a href="global.html#eventListenersQtyButtons">eventListenersQtyButtons</a></li><li><a href="global.html#fetchProducts">fetchProducts</a></li><li><a href="global.html#filterProducts">filterProducts</a></li><li><a href="global.html#flag">flag</a></li><li><a href="global.html#generateUUID">generateUUID</a></li><li><a href="global.html#getProductsId">getProductsId</a></li><li><a href="global.html#getUserCart">getUserCart</a></li><li><a href="global.html#getUserOrdine">getUserOrdine</a></li><li><a href="global.html#getUsrPfp">getUsrPfp</a></li><li><a href="global.html#getWishedProducts">getWishedProducts</a></li><li><a href="global.html#injectForms">injectForms</a></li><li><a href="global.html#inserisciPagamentoTot">inserisciPagamentoTot</a></li><li><a href="global.html#inserisciPagamentoTotManager">inserisciPagamentoTotManager</a></li><li><a href="global.html#isLoggedIn">isLoggedIn</a></li><li><a href="global.html#loadCart">loadCart</a></li><li><a href="global.html#loadOrdersFromLocalStorage">loadOrdersFromLocalStorage</a></li><li><a href="global.html#loadUserOrdiniPage">loadUserOrdiniPage</a></li><li><a href="global.html#loadUserProfile">loadUserProfile</a></li><li><a href="global.html#loadVirtualCart">loadVirtualCart</a></li><li><a href="global.html#loadWishList">loadWishList</a></li><li><a href="global.html#loadWishlistProducts">loadWishlistProducts</a></li><li><a href="global.html#loginAfterRegistration">loginAfterRegistration</a></li><li><a href="global.html#loginModal">loginModal</a></li><li><a href="global.html#modifyData">modifyData</a></li><li><a href="global.html#passVisibility">passVisibility</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#removeCartProd">removeCartProd</a></li><li><a href="global.html#svuotaCarrello">svuotaCarrello</a></li><li><a href="global.html#updateCart">updateCart</a></li><li><a href="global.html#updateCartQty">updateCartQty</a></li><li><a href="global.html#updatePaginationControls">updatePaginationControls</a></li><li><a href="global.html#updatePfpMain">updatePfpMain</a></li><li><a href="global.html#updateQuantity">updateQuantity</a></li><li><a href="global.html#updateWishlist">updateWishlist</a></li><li><a href="global.html#validateBirthDay">validateBirthDay</a></li><li><a href="global.html#validateEmail">validateEmail</a></li><li><a href="global.html#writeActiveWishButtonsToDatabase">writeActiveWishButtonsToDatabase</a></li><li><a href="global.html#zoomImage">zoomImage</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/database/ordine-dao.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const db = require("./db.js");

/**
 * classe che contiene le funzione dao per accedere al db, rigurdante gli ordini
 */
class OrdineDao {
    /**
     * scrive nel db uno specifico ordine fatto da un utente
     * @param UUIDordine identificativo ordine
     * @param nomeProdottoOrdine nome del prodotto
     * @param priceProductOrdine prezzo del prodotto
     * @param quantityProdOrdine quantita del prodotto
     * @param tagliaProdOrdine taglia del prodotto
     * @param emailUtenteOrdine identificativo utente
     * @returns {Promise&lt;void>}
     */
    static async aggiungiOrdine(UUIDordine, nomeProdottoOrdine, priceProductOrdine,
                                quantityProdOrdine, tagliaProdOrdine, emailUtenteOrdine) {
        try {
            // Ottieni la data corrente
            const today = new Date();
            const dataOrdine = today.toISOString().split('T')[0]; // Rende la data in formato "YYYY-MM-DD"
            const prezzoTotale = priceProductOrdine * quantityProdOrdine;
            console.log(prezzoTotale);
            await db.run(
                `INSERT INTO ordine (id_ordine, nome_prodotto_ordine, prezzo_prodotto, 
                                  quantita_ordine, taglia, mail_ordine, data_ordine)
                    VALUES (?, ?, ?, ?, ?, ?, ?)`,
                [UUIDordine, nomeProdottoOrdine, prezzoTotale,
                    quantityProdOrdine, tagliaProdOrdine, emailUtenteOrdine, dataOrdine]
            );
            console.log("Ordine aggiunto con successo.");
        } catch (err) {
            console.error("Errore nell'aggiunta del prodotto al carrello:", err);
            throw err;
        }
    }


    static async aggiungiOrdineIndice(UUIDordine, emailUtenteOrdine) {
        try {
            await db.run(
                `INSERT INTO ordini (id_ordine, email_ordine)
                        VALUES (?, ?)`,
                [UUIDordine, emailUtenteOrdine]
            );
            console.log("Ordine aggiunto con successo.");
        } catch (err) {
            console.error("Errore nell'aggiunta del prodotto al carrello:", err);
            throw err;
        }
    }

    /**
     * funzione che si occupa di calcolare il pagamento totale di un ordine, riferito a uno specifico utene
     * @param UUIDordine identificativo ordine
     * @param emailUtenteOrdine identififcativo utente
     * @returns {Promise&lt;boolean>}
     */
    static async calcolaPagamentoTotaleOrdine(UUIDordine, emailUtenteOrdine) {
        try {
            console.log("UUIDordine:", UUIDordine);
            const query = `
                SELECT SUM(prezzo_prodotto) AS totale 
                FROM ordine
                WHERE id_ordine = ?
            `;
            const result = await new Promise((resolve, reject) => {
                db.get(query, [UUIDordine], (err, row) => {
                    if (err) {
                        reject(err);
                    } else {
                        resolve(row);
                    }
                });
            });
            if (!result || result.totale === null) {
                throw new Error(`No total found for order UUID: ${UUIDordine}`);
            }

            const totalAmount = result.totale;
            console.log("Total Amount:", totalAmount);

            await db.run(
                `INSERT INTO pagamento (id_ordine_pagamento, pagamento_totale, mail_pagamento_totale)
                        VALUES (?, ?, ?)`,
                [UUIDordine, totalAmount || 0, emailUtenteOrdine]
            );

            console.log("Order total inserted successfully into `pagamento`.");
            return true; // Conferma che l'inserimento è stato eseguito correttamente
        } catch (error) {
            console.error("Error calculating and inserting the order total:", error);
            throw error;
        }
    }

    /**
     * ottiene l'ordine di uno specifico utente
     * @param emailUtenteOrdine identificativo utente
     * @returns {Promise&lt;unknown>}
     */
    static async getUserOrdine(emailUtenteOrdine){
        try {
            const query = `SELECT * FROM ordine
                        WHERE mail_ordine = ?`
            return new Promise((resolve, reject) => {
                db.all(query, [emailUtenteOrdine], (err, rows) => {
                    if (err) {
                        reject(err);
                        console.log(err)
                    }else {
                        console.log(rows)
                        resolve(rows)
                    }
                })
            })
        }catch (err){
            console.error("Errore nella rimozione del prodotto:", err);
            throw err;
        }

    }

}

module.exports = OrdineDao</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Sun Dec 01 2024 15:12:22 GMT+0100 (Ora standard dell’Europa centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
