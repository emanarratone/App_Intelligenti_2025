<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>client/js/script/cartController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CartDAO.html">CartDAO</a><ul class='methods'><li data-type='method'><a href="CartDAO.html#.addProductToCart">addProductToCart</a></li><li data-type='method'><a href="CartDAO.html#.decreaseQuantity">decreaseQuantity</a></li><li data-type='method'><a href="CartDAO.html#.getUserCart">getUserCart</a></li><li data-type='method'><a href="CartDAO.html#.getUserCartQuantity">getUserCartQuantity</a></li><li data-type='method'><a href="CartDAO.html#.increaseQuantity">increaseQuantity</a></li><li data-type='method'><a href="CartDAO.html#.removeProductFromCart">removeProductFromCart</a></li></ul></li><li><a href="OrdineDao.html">OrdineDao</a><ul class='methods'><li data-type='method'><a href="OrdineDao.html#.aggiungiOrdine">aggiungiOrdine</a></li><li data-type='method'><a href="OrdineDao.html#.calcolaPagamentoTotaleOrdine">calcolaPagamentoTotaleOrdine</a></li><li data-type='method'><a href="OrdineDao.html#.getUserOrdine">getUserOrdine</a></li></ul></li><li><a href="SpedizoineDAO.html">SpedizoineDAO</a><ul class='methods'><li data-type='method'><a href="SpedizoineDAO.html#.aggiungiSpedizione">aggiungiSpedizione</a></li></ul></li><li><a href="WishlistDAO.html">WishlistDAO</a><ul class='methods'><li data-type='method'><a href="WishlistDAO.html#.addProductToWishlist">addProductToWishlist</a></li><li data-type='method'><a href="WishlistDAO.html#.getUserWishlist">getUserWishlist</a></li><li data-type='method'><a href="WishlistDAO.html#.removeProductFromWishlist">removeProductFromWishlist</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#LocalStrategy">LocalStrategy</a></li><li><a href="global.html#WishListFirtsLog">WishListFirtsLog</a></li><li><a href="global.html#addNewImgManager">addNewImgManager</a></li><li><a href="global.html#addOrdine">addOrdine</a></li><li><a href="global.html#addProductToCart">addProductToCart</a></li><li><a href="global.html#addProfilePic">addProfilePic</a></li><li><a href="global.html#addSpedizione">addSpedizione</a></li><li><a href="global.html#apiRoutes">apiRoutes</a></li><li><a href="global.html#buttonWish">buttonWish</a></li><li><a href="global.html#clickBuyButton">clickBuyButton</a></li><li><a href="global.html#createSuccessHeader">createSuccessHeader</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#effetuaOrdine">effetuaOrdine</a></li><li><a href="global.html#effetuaSpedizione">effetuaSpedizione</a></li><li><a href="global.html#emptyCart">emptyCart</a></li><li><a href="global.html#eventListenersQtyButtons">eventListenersQtyButtons</a></li><li><a href="global.html#fetchProducts">fetchProducts</a></li><li><a href="global.html#filterProducts">filterProducts</a></li><li><a href="global.html#flag">flag</a></li><li><a href="global.html#generateUUID">generateUUID</a></li><li><a href="global.html#getProductsId">getProductsId</a></li><li><a href="global.html#getUserCart">getUserCart</a></li><li><a href="global.html#getUserOrdine">getUserOrdine</a></li><li><a href="global.html#getUsrPfp">getUsrPfp</a></li><li><a href="global.html#getWishedProducts">getWishedProducts</a></li><li><a href="global.html#injectForms">injectForms</a></li><li><a href="global.html#inserisciPagamentoTot">inserisciPagamentoTot</a></li><li><a href="global.html#inserisciPagamentoTotManager">inserisciPagamentoTotManager</a></li><li><a href="global.html#isLoggedIn">isLoggedIn</a></li><li><a href="global.html#loadCart">loadCart</a></li><li><a href="global.html#loadOrdersFromLocalStorage">loadOrdersFromLocalStorage</a></li><li><a href="global.html#loadUserOrdiniPage">loadUserOrdiniPage</a></li><li><a href="global.html#loadUserProfile">loadUserProfile</a></li><li><a href="global.html#loadVirtualCart">loadVirtualCart</a></li><li><a href="global.html#loadWishList">loadWishList</a></li><li><a href="global.html#loadWishlistProducts">loadWishlistProducts</a></li><li><a href="global.html#loginAfterRegistration">loginAfterRegistration</a></li><li><a href="global.html#loginModal">loginModal</a></li><li><a href="global.html#modifyData">modifyData</a></li><li><a href="global.html#passVisibility">passVisibility</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#removeCartProd">removeCartProd</a></li><li><a href="global.html#svuotaCarrello">svuotaCarrello</a></li><li><a href="global.html#updateCart">updateCart</a></li><li><a href="global.html#updateCartQty">updateCartQty</a></li><li><a href="global.html#updatePaginationControls">updatePaginationControls</a></li><li><a href="global.html#updatePfpMain">updatePfpMain</a></li><li><a href="global.html#updateQuantity">updateQuantity</a></li><li><a href="global.html#updateWishlist">updateWishlist</a></li><li><a href="global.html#validateBirthDay">validateBirthDay</a></li><li><a href="global.html#validateEmail">validateEmail</a></li><li><a href="global.html#writeActiveWishButtonsToDatabase">writeActiveWishButtonsToDatabase</a></li><li><a href="global.html#zoomImage">zoomImage</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">client/js/script/cartController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
import {
    addOrdine,
    addSpedizione,
    emptyCart,
    getUserCart, inserisciPagamentoTotManager,
    removeCartProd,
    updateCart,
    updateCartQty
} from "./cartMenager.js";

import {fetchProducts, zoomImage} from "./fetchProducts.js";
import {createProductCardCart} from "./templates/createProductCardCart.js";
import {showSuccessToast} from "./templates/successLogin.js";
import {spedizioneForm} from "./templates/spedizioneForm.js";
import {ordineFormTemplate} from "./templates/ordineForm.js";
import {loadUserOrdiniPage} from "../OrdiniPageController.js";


//struttura dati per caricare i dati del carello di un utente
export let virtualCart = JSON.parse(localStorage.getItem('cartProducts')) || [];

/**
 * Funzione per gestire l'aggiunta al carrello
 * @param product object con tutte le propieta
 * @returns {Promise&lt;void>}
 */
export async function addProductToCart(product) {
    await updateCart(product.id, true)
    virtualCart.push(product);
    console.log("Carrello attuale:", virtualCart);

}

/**
 * carica il localStorage
 * @returns {Promise&lt;void>}
 */
export async function loadVirtualCart() {
    try {
        //prende il carello di un utente
        const result = await getUserCart();
        //prende i prodotti del sito
        const allProducts = await fetchProducts();
        const cartList = result.cart;
        if (cartList &amp;&amp; cartList.length > 0 &amp;&amp; virtualCart.length === 0) {
            cartList.forEach(cartItem => {
                // mette i prodotti che sono nel carello con quelli totali
                const product = allProducts.find(p => p.id === cartItem.Id_prodotto_carrello);
                if (product) {
                    // crea la card
                    const productCard = {
                        name: product.name,
                        price: typeof product.price === 'string'
                            ? parseFloat(product.price.replace('€', '').trim())
                            : product.price,
                        image: product.image,
                        genere: product.genere,
                        id: product.id,
                        quantity: cartItem.quantita
                    };
                    //carica la card
                    virtualCart.push(productCard);
                }
            });
        } else {
            console.warn("Nessun prodotto trovato nel carrello.");
        }
        //console.log(virtualCart);// Attiva i pulsanti di acquisto
    } catch (error) {
        console.error("Errore durante la configurazione dei pulsanti di acquisto:", error);
    }
}

/**
 * mostra le card con i prodotti del carrello utente
 * @param flag gestire il clic degli eventi
 * @returns {Promise&lt;void>}
 */
export async function loadCart(flag) {
    const paginationContainer = document.getElementById('pagination-container');
    if (paginationContainer) {
        paginationContainer.style.display = 'none'; // Nascondi il contatore delle pagine
    }
    const cartContainer = document.getElementById('cart-list');
    cartContainer.innerHTML = '&lt;p>Caricamento dei prodotti nel carrello...&lt;/p>';

    if (cartContainer &amp;&amp; virtualCart.length > 0 &amp;&amp; flag === 0) {
        cartContainer.innerHTML = virtualCart.map(createProductCardCart).join('');
        zoomImage();
        eventListenersQtyButtons()
        eventListeners()
    }else if (flag === 1){
        cartContainer.innerHTML = virtualCart.map(createProductCardCart).join('');
        zoomImage();
        eventListenersQtyButtons()
    }else {
        console.error('Nessun prodotto disponibile o errore nella struttura dei dati.');
        cartContainer.innerHTML = '&lt;p>Nessun prodotto salvato nel carrello.&lt;/p>';
        showSuccessToast("Non perderti i nostri proddotti")
    }
}

/**
 * attiva bottone di aggiunta carrello per ogni prodotto
 * @returns {Promise&lt;void>}
 */
export async function clickBuyButton() {
    document.querySelectorAll('.buy-button').forEach(button => {
        button.addEventListener('click', async () => {
            const productElement = button.closest('.card');
            const productId = parseInt(productElement.getAttribute('data-id')); // Ottieni l'ID del prodotto

            // Cerca il prodotto in virtualCart
            const existingProduct = virtualCart.find(item => item.id === productId);

            if (existingProduct) {
                console.log("prodotto esistente", existingProduct)
                // Se il prodotto esiste, aumenta la quantità di 1
                existingProduct.quantity += 1;
                await updateCartQty(productId, true);
                console.log(`Quantità aggiornata per il prodotto con ID ${productId}:`, existingProduct.quantity);
            } else {
                // Se il prodotto non esiste, creane uno nuovo con quantità iniziale 1
                const product = {
                    name: productElement.querySelector('.card-title').textContent,
                    price: parseFloat(productElement.querySelector('.card-text').textContent.replace('€', '').trim()),
                    image: productElement.querySelector('.product-image').src,
                    genere: productElement.querySelector('.card-text:nth-child(3)').textContent,
                    id: productId,
                    quantity: 1
                };
                await addProductToCart(product)
                console.log("Prodotto aggiunto al carrello:", product);
            }
            showSuccessToast("Prodotto aggiunto al carrello");
        });
    });
}

/**
 * aggiorna la quantita del prodotto nel carello
 * @param productId id del prodotto
 * @param flag per vedere se incrementare o decrementare
 * @returns {Promise&lt;void>}
 */
export async function updateQuantity(productId, flag) {
    const product = virtualCart.find(product => product.id === productId);
    const productElement = document.querySelector(`.card[data-id="${productId}"]`);
    if (!productElement) {
        console.error("Elemento prodotto non trovato nel DOM.");
        return;
    }
    if (flag === false) {
        if (product &amp;&amp; product.quantity > 1) {
            product.quantity -= 1;
            localStorage.setItem('cartProducts', JSON.stringify(virtualCart));
            await updateCartQty(productId,false);
            await loadCart(1);
        } else if (product &amp;&amp; product.quantity === 1) {
            // Rimuovi il prodotto se la quantità è zero
            productElement.remove();
            virtualCart = virtualCart.filter(p => p.id !== productId);
            localStorage.setItem('cartProducts', JSON.stringify(virtualCart));
            await updateCartQty(productId,false);
            console.log(`Prodotto con ID ${productId} rimosso dal carrello.`);
            await removeCartProd(productId)
        }
    } else if (flag === true) {
        if (product &amp;&amp; product.quantity >= 1) {
            product.quantity += 1;
            localStorage.setItem('cartProducts', JSON.stringify(virtualCart));
            await updateCartQty(productId, true);
            await loadCart(1);
        }
    }
}

/**
 * Funzione per iniettare il form di spedizione nel DOM
 */
function injectForms() {
    // Inietta il form nel body all'inizio, se non è già presente
    if (!document.getElementById('shipping-form-container')) {
        document.body.insertAdjacentHTML('beforeend', spedizioneForm());
    }

}

/**
 * funzione dedicata per l'ascolto degli eventi del carrello
 * @type {boolean}
 */
let flag = false;
function eventListeners(){
    if (flag === false){
        injectForms();
        flag = true;
    }

    const ordineModal = new bootstrap.Modal(document.getElementById('ordineModal'));
    const shippingModal = new bootstrap.Modal(document.getElementById('shippingModal'));
    /**
     * evento quando clicco il button acquista nel carrello
     */
    document.getElementById('button-acquista').addEventListener('click', async () => {
        // Mostra il primo modal (ordineModal)
        ordineModal.show();
        const productsCart = await getUserCart();
        const matchingProducts = virtualCart.filter(item =>
            productsCart.cart.some(cartItem => cartItem.Id_prodotto_carrello === item.id)
        );
        //console.log("carrellooo" ,matchingProducts);
        ordineFormTemplate(matchingProducts);

        /**
         * evento per andare avanti nella compilazione del form del acquisto
         */
        document.getElementById('button-avanti-ordine').addEventListener('click', (event) => {
            event.preventDefault(); // Previene il submit del form per il primo modal
            ordineModal.hide();

            // Crea un array per raccogliere i dettagli degli ordini
            const cartDetails = [];

            // Seleziona tutti gli elementi di prodotto nel carrello
            virtualCart.forEach((product, index) => {
                const size = document.getElementById(`size${index}`).value; // Recupera la taglia selezionata
                const quantity = document.getElementById(`quantity${index}`).textContent; // Recupera la quantità
                console.log(quantity)
                // Aggiungi un oggetto con i dettagli del prodotto all'array
                cartDetails.push({
                    name: product.name,
                    price: product.price,
                    size: size,
                    quantity: parseInt(quantity, 10)
                });
            });
            //cnsole.log(cartDetails);

            // Crea l'istanza del modale di spedizione solo una volta
            shippingModal.show();

            /**
             * Registrazione dell'evento di submit per il modulo di spedizione
             * @param event
             * @returns {Promise&lt;void>}
             */
            document.getElementById('button-submit-spedizione').onclick = async (event) => {
                event.preventDefault(); // Evita il comportamento di default

                // Raccoglie i valori dagli input
                let UUID = generateUUID();
                const nazione = document.getElementById('country').value;
                const citta = document.getElementById('city').value;
                const indirizzo = document.getElementById('address').value;

                try {
                    //scrive gli ordini per ogni prodotto nel carrello ecco perchè Promise.all
                    const orderResults = await Promise.all(cartDetails.map(item =>
                        effetuaOrdine(UUID, item.name, item.price, item.quantity, item.size)
                    ));

                    const allOrdersSuccess = orderResults.every(result => result);
                    //console.log(allOrdersSuccess);
                    const success = await effetuaSpedizione(nazione, citta, indirizzo, UUID);
                    //console.log(success);
                    if (success) {
                        await inserisciPagamentoTot(UUID)
                        await svuotaCarrello()
                        await loadUserOrdiniPage()
                        shippingModal.hide();

                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    } else {
                        console.log("Errore nella spedizione, nessun reindirizzamento.");
                    }
                } catch (error) {
                    console.error("Errore durante l'invio della spedizione:", error);
                }
            };
        });

    });
}

/**
 * Ascolta eventi dei bottoni incremento/decremento e rimuovi prodotto da carrello
 */
function eventListenersQtyButtons(){
    document.querySelectorAll('.quantity-decrease').forEach(button => {
        button.addEventListener('click', async event => {
            const productId = parseInt(button.closest('.card').getAttribute('data-id'));
            await updateQuantity(productId, false);
        });
    });

    document.querySelectorAll('.quantity-increase').forEach(button => {
        button.addEventListener('click', async event => {
            const productId = parseInt(button.closest('.card').getAttribute('data-id'));
            await updateQuantity(productId, true);
        });
    });

    document.querySelectorAll('.remove-button').forEach(button => {
        button.addEventListener('click', async event => {
            const productId = parseInt(button.closest('.card').getAttribute('data-id'));
            const productElement = document.querySelector(`.card[data-id="${productId}"]`);
            productElement.remove();
            virtualCart = virtualCart.filter(p => p.id !== productId);
            localStorage.setItem('cartProducts', JSON.stringify(virtualCart));
            await removeCartProd(productId);
        });
    });
}

/**
 * genera un UUID per identificare ogni singolo ordine
 * @returns {*}
 */
function generateUUID() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] &amp; 15 >> c / 4).toString(16)
    );
}

/**
 * chiamata al manager
 * @param UUIDordine identificativo del prdotto
 * @param nomeProdottoOrdine nome del prodotto
 * @param priceProductOrdine prezzo del prodotto
 * @param quantityProdOrdine qty del porddoto
 * @param tagliaProdOrdine taglia del proddotto
 * @returns {Promise&lt;boolean>}
 */
export async function effetuaOrdine(UUIDordine ,nomeProdottoOrdine, priceProductOrdine,
                                    quantityProdOrdine, tagliaProdOrdine){
    try {
        const success = await addOrdine(UUIDordine ,nomeProdottoOrdine, priceProductOrdine,
                                            quantityProdOrdine, tagliaProdOrdine);
        if (success) {
            return true;
        } else {
            return false;
        }
    } catch (err) {
        return false;
    }
}

/**
 * chiamata al manager per la spedizione
 * @param nazione
 * @param citta
 * @param indirizzo
 * @param UUID
 * @returns {Promise&lt;boolean>}
 */
export async function effetuaSpedizione(nazione, citta, indirizzo, UUID) {
    try {
        const success = await addSpedizione(nazione, citta, indirizzo, UUID);
        if (success) {
            return true;
        } else {
            return false;
        }
    } catch (err) {
        return false;
    }
}

/**
 * chiamata al manager per svuotare il carello dopo un acquisto
 * @returns {Promise&lt;boolean>}
 */
export async function svuotaCarrello(){
    try {
        const success = await emptyCart();
        if (success) {
            return true;
        } else {
            return false;
        }
    } catch (err) {
        return false;
    }
}

/**
 * chiamata al manager per inserire il pagamento totale di un ordine
 * @param UUIDordine
 * @returns {Promise&lt;boolean>}
 */
export async function inserisciPagamentoTot(UUIDordine){
    try {
        const success = await inserisciPagamentoTotManager(UUIDordine);
        if (success) {
            return true;
        } else {
            return false;
        }
    } catch (err) {
        return false;
    }
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Sun Dec 01 2024 15:12:22 GMT+0100 (Ora standard dell’Europa centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
